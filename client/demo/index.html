<html>
  <head><title>Websockets Authentication POC</title></head>
    <body>
      <script src="http://www.google.com/jsapi"></script>
      <script>google.load("jquery", "1.3")</script>
      <script src="http://jquery-json.googlecode.com/files/jquery.json-2.2.min.js"></script>
      <button id="login">Login</button>
      <button id="logout">Logout</button><br>
      <ul>
        <li id="content"></li>
      </ul>
      <script src="https://login.persona.org/include.js"></script>
      <script src="/vendors/webmaker-auth-client/dist/webmaker-auth-client.min.js"></script>
      <script src="/vendors/rc-socket.js/dist/rc-socket.js"></script>
      <script src="/vendors/superagent/superagent.js"></script>
      <script>
        var loginEl = document.querySelector('#login');
        var logoutEl = document.querySelector('#logout');
        var token;

        var auth = new WebmakerAuthClient({
          host: '',
          paths: {
            authenticate: '/authenticate',
            create: '/create',
            verify: '/verify',
            logout: '/logout'
          },
          csrfToken: 'YOURCSRFTOKEN',
          audience: window.location.origin,
          prefix: 'webmaker-', // for local storage
          timeout: 10,
          handleNewUserUI: true // Do you want to auto-open/close the new user UI?
        });

        // Attach event listeners!
        auth.on('login', function(user, debuggingInfo){
          window.superagent.get('/gettoken', function(req, res){
            if(res.status != 200){
              return console.log(debuggingInfo);
            }
            token = JSON.parse(res.text);
          });
          var socket = new WebSocket("ws://127.0.0.1:8181/");
          socket.onopen = function(e){
            console.log('Websocket connection successfully opened!');
            console.log('what\'s in the token object?', JSON.stringify({token: token.tokens[0]}));
            socket.send(JSON.stringify({token: token.tokens[0]}));
          };
          socket.onmessage = function(e){
            try{
              console.log('e.data typof', typeof e.data);
              var data = e.data;
              console.log('data:', data);
              if(data == 'authenticated!'){
                  console.log('- authenticated');
              }
              $('#content').append(data + '<br>');
            }
            catch(e){
              console.log(e);
            }
          };
          socket.onerror = function(e){
            console.log(e);
          };
          socket.onclose = function(e) {
            console.log(e);
          }
        });
        auth.on('logout', function() {
          console.log('logout');
        });
        // Run this function to automatically log-in users with a session set.
        auth.verify();

        // Use auth.login and auth.logout to login and out!
        loginEl.addEventListener('click', auth.login, false);
        logoutEl.addEventListener('click', auth.logout, false);

      </script>
      <script>

      </script>
  </body>
</html>
